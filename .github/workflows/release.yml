name: Create Release

on:
  workflow_dispatch:
    inputs:
      version:
        description: "Release version (e.g., 1.4.3)"
        required: true
        type: string
      prerelease:
        description: "Mark as pre-release"
        required: false
        type: boolean
        default: false

permissions:
  contents: write

jobs:
  build-and-release:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Verify version matches manifest
        run: |
          MANIFEST_VERSION=$(grep '^version = ' blender_manifest.toml | cut -d'"' -f2)
          if [ "$MANIFEST_VERSION" != "${{ github.event.inputs.version }}" ]; then
            echo "Error: Version mismatch!"
            echo "Manifest version: $MANIFEST_VERSION"
            echo "Input version: ${{ github.event.inputs.version }}"
            exit 1
          fi
          echo "Version verified: $MANIFEST_VERSION"

      - name: Build extension
        run: |
          python build_extension.py

      - name: Find built extension
        id: find_zip
        run: |
          ZIP_FILE=$(ls furion_render_helper_v*.zip | head -n 1)
          if [ -z "$ZIP_FILE" ]; then
            echo "Error: No extension zip file found!"
            exit 1
          fi
          echo "zip_file=$ZIP_FILE" >> $GITHUB_OUTPUT
          echo "Found extension: $ZIP_FILE"

      - name: Extract changelog for this version
        id: changelog
        run: |
          # Extract changelog from README.md for this version
          VERSION="${{ github.event.inputs.version }}"

          # Try to extract changelog section (between version header and next ## or end)
          CHANGELOG=$(awk "/## Version $VERSION/,/^## [^V]/" README.md | sed '1d;$d' || echo "No changelog found")

          if [ "$CHANGELOG" = "No changelog found" ]; then
            CHANGELOG="Release version $VERSION"
          fi

          # Save to file for multiline output
          echo "$CHANGELOG" > changelog.txt
          echo "Extracted changelog:"
          cat changelog.txt

      - name: Create Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: v${{ github.event.inputs.version }}
          name: Furion Render Helper v${{ github.event.inputs.version }}
          body_path: changelog.txt
          files: ${{ steps.find_zip.outputs.zip_file }}
          draft: false
          prerelease: ${{ github.event.inputs.prerelease }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Release Summary
        run: |
          echo "âœ… Release created successfully!"
          echo "ðŸ“¦ Version: ${{ github.event.inputs.version }}"
          echo "ðŸ“„ File: ${{ steps.find_zip.outputs.zip_file }}"
          echo "ðŸ”— Release URL: https://github.com/${{ github.repository }}/releases/tag/v${{ github.event.inputs.version }}"
